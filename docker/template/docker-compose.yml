version: "3.5"

networks:
  # Create an explicit network so we can connect to it from the client to do deployments.
  casperlabs:
    name: casperlabs

# Cross mounting volumes: https://github.com/docker/compose/issues/3211
volumes:
  socketvolume: {}

# Base template for nodes. Can't use replicas unfortunately becuase we have to pair them
# with an execution engine. Alternatively we could build a single image.

services:
  # For repeating configs, we could use extension fields: https://medium.com/@kinghuang/docker-compose-anchors-aliases-extensions-a1e4105d70bd

  # Not going to expose ports on the host because there will be many nodes.
  # We can use a docker container to run the client and connect to the right casperlabs network
  # and pick one particular node.

  node:
    image: io.casperlabs/node:latest
    container_name: node-${NODE_NUMBER}
    volumes:
      # Volume for a socket to be created and shared with the execution engine.
      - socketvolume:/opt/docker/.sockets
      # Common bonds files. Don't map the .casperlabs directory itself so nodes can create SSL keys.
      - $PWD/../.casperlabs/genesis:/root/.casperlabs/genesis
    networks:
      - casperlabs
    environment:
      HOME: /root
    # Using files created by running the node once as described in https://slack-files.com/TDVFB45LG-FFBGDQSBW-bad20239ec
    # Later all need to agree on the same validators so these are committed to git and mounted.
    command:
      - run
      - -s
      - --casper-validator-private-key
      - $VALIDATOR_PRIVATE_KEY
      - --casper-validator-public-key
      - $VALIDATOR_PUBLIC_KEY
      - --grpc-socket
      - /opt/docker/.sockets/.casper-node.sock
    depends_on:
      - execution-engine


  execution-engine:
    image: io.casperlabs/execution-engine:latest
    container_name: execution-engine-${NODE_NUMBER}
    volumes:
      - socketvolume:/opt/docker/.sockets
    networks:
      - casperlabs
    command:
      - .sockets/.casper-node.sock
